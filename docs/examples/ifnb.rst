IFNb PBMC example
=================

Setting up
----------

1. Clone the example template to a local folder
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Clone the folders and files for the example into a local folder.

  cp -r /path/to/cellhub/examples/ifnb_pbmc/* .

This will create 3 folders:

- "cellhub" where the preprocessing pipelines will be run and where the cellhub database will be created
- "integration" where integration is to be performed.
- "cluster" where we can perform downstream analysis with "cellhub cluster".


Running the pre-processing pipelines and creating the database
--------------------------------------------------------------

2. Running Cellranger
^^^^^^^^^^^^^^^^^^^^^

The first step is to configure and run pipeline_cellranger_multi. We already have a pre-configured yml file so we can skip this step but the syntax is included for reference here and also for the other steps: ::

  # enter the cellhub directory

  cd cellhub

  # cellhub cellranger_multi config

Edit the pipeline_cellranger_multi.yml file as appropriate to point to folders containing fastq files extracted from the original BAM files submitted by `Kang et. al. <https://doi.org/10.1038/nbt.4042>`_ to GEO (GSE96583). The GEO identifiers are: unstimulated (GSM2560248) and stimulated (GSM2560249). The fastqs can be extracted with the `10X bamtofastq tool <https://support.10xgenomics.com/docs/bamtofastq>`_.

We can run the pipeline as follows: ::

  cellhub cellranger_multi make full -v5 -p20

Finally, the count matrices must be manually registered on the API for downstream analysis: ::

  cellhub cellranger useCounts


3. Running the cell qc pipeline
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Next we run the cell qc pipeline::

  # cellhub cell_qc config

  cellhub cell_qc make full -v5 -p20


4. Running emptydrops and investigating ambient RNA (optional)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

If desired we can run emptydrops::

  # cellhub emptydrops config

  cellhub emptydrops make full -v5 -p20

And investigate the ambient rna::

  # cellhub ambient_rna config

  cellhub ambient_rna make full -v5 -p20 


5. Run pipeline_singleR
^^^^^^^^^^^^^^^^^^^^^^^^

Single R is run on all the cells so that the results are avaliable to help with QC
as well as downstream analysis::

  # cellhub singleR config
  
  cellhub singleR make full -v5 -p20
  
As noted: :doc:`in the pipeline_singleR inputs section <pipelines/pipeline_singleR>` the celldex references
neede to be stashed before the pipeline is run.


6. Loading the cell statistics into the celldb
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The cell QC statistics and metadata ("samples.tsv") are next loaded into a local sqlite database::

  # cellhub celldb config

  cellhub celldb make full -v5 -p20


7. Run pipeline_annotation
^^^^^^^^^^^^^^^^^^^^^^^^^^

This  pipeline retrieves Ensembl and KEGG annotations needed for downstream analysis.::

  # cellhub annotation config
  
  cellhub annotation make full -v5 -p10 
  
Please note that the specified Ensembl version should match that used for the cellranger reference trancriptome.


Performing cell QC
------------------


8. Assessment of cell quality
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

This step is left to the reader to perform manually because it needs to be carefully tailored to individual datasets.


Performing downstream analysis
------------------------------


9. Fetch cells for integration
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

We use pipeline_fetch_cells to retrieve the cells we want for downstream analysis. (QC thresholds and e.g. desired samples are specified in the pipeline_fetch_cells.yml) file::

  # It is recommended to fetch the cells in to a seperate directory for integration.
  cd ../integration

  # cellhub fetch_cells config
  cellhub fetch_cells make full -v5 -p20 


10. Integration
^^^^^^^^^^^^^^^

Run the provided jupyter notebook to perform a basic Harmony integration of the data and to save it in the appropriate anndata format (see :doc:`in the pipeline_cluster inputs section <pipelines/pipeline_cluster>`) is provided.


11. Clustering analysis
^^^^^^^^^^^^^^^^^^^^^^^

Cluster analysis is performed with pipeline cluster (a seperate directory is recommended for this so that multiple clustering runs can be performed as required).::

  # change into the clustering directory
  cd ../cluster.dir

  # checkout the yml file
  cellhub cluster config
  
  # a suitable yml file has been provided so we can now launch the pipeline
  cellhub cluster make full -v5 -p200

The pdf reports and excel files generated by the pipeline can be found in the "reports.dir" subfolder.

For interactive visulation, the results are provided in cellxgene format. To view the cellxgene.h5ad files, you will first need toinstall cellxgene with "pip install cellxgene". The cellxgene viewer can then be launched with: ::

  # substitute "{x}" with the number integrated components used for the clustering run.
  cellxgene --no-upgrade-check launch out.{x}.comps.dir/cellxgene.h5ad
