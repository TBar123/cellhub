<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Coding Guidelines &mdash; cellhub 0.1 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API" href="API.html" />
    <link rel="prev" title="IFNb PBMC example" href="IFNbExample.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> cellhub
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="Installation.html">Installation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="WorkflowOverview.html">Workflow Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="Usage.html">Usage</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="IFNbExample.html">IFNb PBMC example</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Coding Guidelines</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#repository-layout">Repository layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="#coding-style">Coding style</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#python">Python</a></li>
<li class="toctree-l3"><a class="reference internal" href="#r">R</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#writing-pipelines">Writing pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="#writing-pipeline-tasks">Writing pipeline tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cell-indexing">Cell indexing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#yaml-configuration-file-naming">Yaml configuration file naming</a></li>
<li class="toctree-l2"><a class="reference internal" href="#writing-and-compiling-the-documentation">Writing and compiling the documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="API.html">API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tasks/parameters.html">Parameters submodule</a></li>
<li class="toctree-l1"><a class="reference internal" href="tasks/setup.html">setup.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="tasks/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="tasks/profile.html">profile.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="tasks/profile.html#usage">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="tasks/profile.html#code">Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="tasks/cellbender.html">Cellbender tasks</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="pipelines/pipeline_adt_norm.html">Pipeline ADT normalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipelines/pipeline_ambient_rna.html">Pipeline ambient rna</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipelines/pipeline_annotation.html">Pipeline annotation</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipelines/pipeline_cellbender.html">Pipeline cellbender</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipelines/pipeline_celldb.html">Pipeline celldb</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipelines/pipeline_cellranger_multi.html">Pipeline Cellranger Multi</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipelines/pipeline_cell_qc.html">Pipeline Cell QC</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipelines/pipeline_cluster.html">Pipeline cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipelines/pipeline_dehash.html">Pipeline dehash</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipelines/pipeline_emptydrops.html">Pipeline Emptydrops</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipelines/pipeline_fetch_cells.html">Pipeline fetch cells</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipelines/pipeline_singleR.html">Pipeline singleR</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipelines/pipeline_velocyto.html">Pipeline Velocyto</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">cellhub</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Coding Guidelines</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/CodingGuidelines.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="coding-guidelines">
<h1>Coding Guidelines<a class="headerlink" href="#coding-guidelines" title="Permalink to this heading"></a></h1>
<section id="repository-layout">
<h2>Repository layout<a class="headerlink" href="#repository-layout" title="Permalink to this heading"></a></h2>
<table class="colwidths-given docutils align-default" id="id1">
<caption><span class="caption-text">Repository layout</span><a class="headerlink" href="#id1" title="Permalink to this table"></a></caption>
<colgroup>
<col style="width: 20%" />
<col style="width: 80%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Folder</p></th>
<th class="head"><p>Contents</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>cellhub</p></td>
<td><p>The cellhub Python module which contains the set of CGAT-core pipelines</p></td>
</tr>
<tr class="row-odd"><td><p>cellhub/tasks</p></td>
<td><p>The cellhub tasks submodule which contains helper functions and pipeline task definitions</p></td>
</tr>
<tr class="row-even"><td><p>cellhub/reports</p></td>
<td><p>The latex source files used for building the reports</p></td>
</tr>
<tr class="row-odd"><td><p>Python</p></td>
<td><p>Python worker scripts that are executed by pipeline tasks</p></td>
</tr>
<tr class="row-even"><td><p>R/cellhub</p></td>
<td><p>The R cellhub library</p></td>
</tr>
<tr class="row-odd"><td><p>R/scripts</p></td>
<td><p>R worker scripts that are executed by pipeline tasks</p></td>
</tr>
<tr class="row-even"><td><p>docsrc</p></td>
<td><p>The documentation source files in restructured text format for compilation with sphinx</p></td>
</tr>
<tr class="row-odd"><td><p>docs</p></td>
<td><p>The compiled documentation</p></td>
</tr>
<tr class="row-even"><td><p>examples</p></td>
<td><p>Configuration files for example datasets</p></td>
</tr>
<tr class="row-odd"><td><p>conda</p></td>
<td><p>Conda environment, TBD</p></td>
</tr>
<tr class="row-even"><td><p>tests</p></td>
<td><p>TBD</p></td>
</tr>
</tbody>
</table>
</section>
<section id="coding-style">
<h2>Coding style<a class="headerlink" href="#coding-style" title="Permalink to this heading"></a></h2>
<p>Currently we are working to improve and standardise the coding style:</p>
<section id="python">
<h3>Python<a class="headerlink" href="#python" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p>Python code should be <a class="reference external" href="https://www.python.org/dev/peps/pep-0008/">pep8</a> compliant. Compliance checks will be enforced soon.</p></li>
<li><p>Arguments to Python scripts should be parsed with argparse.</p></li>
<li><p>Logging in Python scripts should be performed with the standard library “logging” module, written to stdout and redirected to a log file in the pipeline task.</p></li>
</ul>
</section>
<section id="r">
<h3>R<a class="headerlink" href="#r" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p>R code should follow the <a class="reference external" href="https://style.tidyverse.org">tidyverse style guide</a>. Please do not use right-hand assignment.</p></li>
<li><p>Arguments to R scripts should be parsed with optparse.</p></li>
<li><p>Logging in R scripts should be performed with the “futile.logger” library, written to stdout and redirect to a log file specified in the pipeline task.</p></li>
<li><p>Otherwise, to write to stdout from R scripts use message() or warning(). Do not use print() or cat().</p></li>
</ul>
</section>
</section>
<section id="writing-pipelines">
<h2>Writing pipelines<a class="headerlink" href="#writing-pipelines" title="Permalink to this heading"></a></h2>
<p>The pipelines live in the “cellhub” python module.</p>
<p>Auxiliary task functions live in the “cellhub/task” python sub-module.</p>
<p>In the notes below “xxx” denotes the name of a pipeline such as e.g. “cell_qc”.</p>
<ol class="arabic simple">
<li><p>Paths should never be hardcoded in the pipelines - rather they must be read from the yaml files.</p></li>
<li><p>Yaml configuration files are named pipeline_xxx.yml</p></li>
<li><p>The output of individual pipelines should be written to a subfolder name “xxx.dir” to keep the root directory clean (it should only contain these directories and the yml configuration files!).</p></li>
<li><p>Pipelines that generate cell-level information for down-stream analysis must read their inputs from the api and register their public outputs to the API, see <a class="reference internal" href="API.html"><span class="doc">API</span></a>. If you need information from an upstream pipeline that is not present on the API please raise an issue.</p></li>
<li><p>We are documenting the pipelines using the sphinx “autodocs” module: please maintain informative rst docstrings.</p></li>
</ol>
</section>
<section id="writing-pipeline-tasks">
<h2>Writing pipeline tasks<a class="headerlink" href="#writing-pipeline-tasks" title="Permalink to this heading"></a></h2>
<p>In cellub, we structure our pipeline tasks as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ruffus</span>
<span class="kn">import</span> <span class="nn">cgatcore.pipeline</span> <span class="k">as</span> <span class="nn">P</span>
<span class="kn">import</span> <span class="nn">cgatcore.iotools</span> <span class="k">as</span> <span class="nn">IOTools</span>
<span class="kn">import</span> <span class="nn">cellhub.tasks</span> <span class="k">as</span> <span class="nn">T</span>

<span class="n">PARAMS</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">(</span><span class="o">....</span><span class="p">)</span>

<span class="nd">@files</span><span class="p">(</span><span class="s2">&quot;a.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;results.dir/my_task.sentinel&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_task</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">outfile</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Example task&#39;&#39;&#39;</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">PARAMS</span><span class="p">,</span>
                <span class="n">memory</span><span class="o">=</span><span class="s2">&quot;4GB&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">make_outdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">results_file</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.sentinel&quot;</span><span class="p">,</span> <span class="s2">&quot;.tsv.gz&quot;</span><span class="p">)</span>

    <span class="n">statement</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39; python code.py</span>
<span class="s1">                    --arg1=</span><span class="si">%(infile)s</span><span class="s1"></span>
<span class="s1">                    --args=</span><span class="si">%(parameter_x)s</span><span class="s1"></span>
<span class="s1">                    --arg2=</span><span class="si">%(outdir)s</span><span class="s1"></span>
<span class="s1">                    --arg3=</span><span class="si">%(results_file)s</span><span class="s1"></span>
<span class="s1">                    &amp;&gt; </span><span class="si">%(log_file)s</span><span class="s1"></span>
<span class="s1">                &#39;&#39;&#39;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">PARAMS</span><span class="p">,</span> <span class="o">**</span><span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>

    <span class="n">P</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="o">**</span><span class="n">t</span><span class="o">.</span><span class="n">resources</span><span class="p">)</span>

    <span class="n">IOTools</span><span class="o">.</span><span class="n">touch_file</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
</pre></div>
</div>
<p>As shown in the  example, we adopt the following conventions:</p>
<ol class="arabic simple">
<li><p>The task output is an empty sentinel file. It will only be written if
the task returns without an error. This ensures that the pipeline does not
proceed with partial results.</p></li>
<li><p>An instance, “t”, of the cellhub.tasks.setup class is created. Based on the arguments
provided, it is populated with useful variables (see above), including the parsed resource requirements.
By default, the class constructor will create the output directory (if it does not already
exist) based on the outfile name.</p></li>
<li><p>The stderr and stdout are captured to a log file. By default t.log_file is populated
with the outfile name with “.sentinel” replaced by “.log”.</p></li>
<li><p>The statement is substituted with variables from the PARAMS, t.var and locals() dictionaries as
required. Note that variable names must be unique across the dictionaries provided.</p></li>
<li><p>The resources needed are passed to P.run() as kwargs via the t.resources dictionary.</p></li>
</ol>
</section>
<section id="cell-indexing">
<h2>Cell indexing<a class="headerlink" href="#cell-indexing" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>Tables of per-cell information registered on the API must have columns “barcode” (for the original Cellranger assigned barcode, “-1” suffix not removed) and “library_id”. These two columns are used by pipeline_celldb.py to join the tables in the database.</p></li>
<li><p>Downstream of fetch_cells, when cells are aggregated across libraries, we use unique cell identifiers made by combining the barcode and library id in [AGCT]-library_id format (with the “-1” suffix now removed from the original barcode). The unique cell identifiers are used to populate the anndata.obs.index and the “barcode_id” column in tsv files where needed.</p></li>
</ul>
</section>
<section id="yaml-configuration-file-naming">
<h2>Yaml configuration file naming<a class="headerlink" href="#yaml-configuration-file-naming" title="Permalink to this heading"></a></h2>
<p>The cgat-core system only supports configuration files name “pipeline.yml”.</p>
<p>We work around this by overriding the cgat-core functionality using a helper function in cellhub.tasks.control as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">Pipeline</span> <span class="k">as</span> <span class="nn">P</span>
<span class="kn">import</span> <span class="nn">cellhub.tasks.control</span> <span class="k">as</span> <span class="nn">C</span>

<span class="c1"># Override function to collect config files</span>
<span class="n">P</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">write_config_files</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">write_config_files</span>
</pre></div>
</div>
<p>Default yml files must be located at the path cellhub/yaml/pipeline_xxx.yml</p>
</section>
<section id="writing-and-compiling-the-documentation">
<h2>Writing and compiling the documentation<a class="headerlink" href="#writing-and-compiling-the-documentation" title="Permalink to this heading"></a></h2>
<p>The source files for the documentation are found in:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docsrc</span>
</pre></div>
</div>
<p>The documentation source files for the pipelines can be found in:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docsrc</span><span class="o">/</span><span class="n">pipelines</span>
</pre></div>
</div>
<p>To build the documentation cd to the docsrc folder and run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">github</span>
</pre></div>
</div>
<p>This will build the documentation and copy the latex output to the “docs” folder. You then need to cd to the “docs” folder and run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span>
</pre></div>
</div>
<p>To compile the pdf.</p>
<p>When the repo is made public we will switch to using html documentation on readthedocs. Unfortunately there is no straightforward solution for private html hosting.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="IFNbExample.html" class="btn btn-neutral float-left" title="IFNb PBMC example" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="API.html" class="btn btn-neutral float-right" title="API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Sansom lab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>